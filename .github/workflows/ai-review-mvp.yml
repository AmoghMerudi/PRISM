name: AI PR Review (MVP, no secrets)

on:
  pull_request:
    types: [opened, reopened]

jobs:
  ai_review:
    runs-on: ubuntu-latest
    steps:
      - name: Gather PR metadata
        id: meta
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "additions=${{ github.event.pull_request.additions }}" >> $GITHUB_OUTPUT
          echo "deletions=${{ github.event.pull_request.deletions }}" >> $GITHUB_OUTPUT
          echo "changed_files=${{ github.event.pull_request.changed_files }}" >> $GITHUB_OUTPUT

      - name: Fetch PR diff (truncated)
        id: diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          PR="${{ github.event.pull_request.number }}"
          DIFF_URL="https://api.github.com/repos/${REPO}/pulls/${PR}"
          DIFF=$(curl -sS -H "Accept: application/vnd.github.v3.diff" -H "Authorization: Bearer $GITHUB_TOKEN" "$DIFF_URL")
          TRUNC="${DIFF:0:20000}"
          echo "::set-output name=diff::${TRUNC}"

      - name: Call Render AI service (no secret)
        env:
          RENDER_AI_URL: "https://your-render-host.example.com" # <-- replace with your Render URL
        run: |
          PAYLOAD=$(jq -n \
            --arg repo "${{ steps.meta.outputs.repo }}" \
            --argjson pr_number ${{ steps.meta.outputs.pr_number }} \
            --arg author "${{ steps.meta.outputs.author }}" \
            --argjson additions ${{ steps.meta.outputs.additions }} \
            --argjson deletions ${{ steps.meta.outputs.deletions }} \
            --argjson changed_files ${{ steps.meta.outputs.changed_files }} \
            --arg diff "${{ steps.diff.outputs.diff }}" \
            '{repo:$repo,pr_number:$pr_number,author:$author,additions:$additions,deletions:$deletions,changed_files:$changed_files,diff:$diff,lint_passed:false}')
          curl --fail --retry 2 --retry-delay 2 -X POST "$RENDER_AI_URL/analyze-pr" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" -o response.json || true
          cat response.json || true

      - name: Comment on PR with AI summary (optional)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUMMARY=$(jq -r '.summary // "No summary returned."' response.json)
          PR_SCORE=$(jq -r '.pr_score // "unknown"' response.json)
          BODY="**AI review (MVP)**\n\nScore: \`${PR_SCORE}\`\n\nSummary:\n\n${SUMMARY}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -X POST \
            -d "$(jq -nc --arg body "$BODY" '{body:$body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" > /dev/null